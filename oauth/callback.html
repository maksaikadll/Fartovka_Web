<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fartovka - OAuth Callback</title>
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, #0A1A2E 0%, #1A2F4A 100%);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            text-align: center;
        }
        .container {
            background: rgba(26, 47, 74, 0.9);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            max-width: 400px;
        }
        .loading {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #00bfff;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 1rem;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
    </style>
</head>
<body>
    <div class="container">
        <div id="loading" class="loading"></div>
        <h2 id="status">–û–±—Ä–∞–±–æ—Ç–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...</h2>
        <p id="message">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ</p>
    </div>

    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –Ω–∏–∫–Ω–µ–π–º–∞
        function generateUniqueNickname(provider, userData) {
            const baseName = userData.login || userData.username || userData.name ||
                            userData.global_name || `${provider}_user_${userData.id || Date.now()}`;

            let nickname = baseName.replace(/[^a-zA-Z0-9_]/g, '_').toLowerCase();

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å (–≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –∑–¥–µ—Å—å –±—ã–ª –±—ã –∑–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É)
            let counter = 1;
            const originalNickname = nickname;
            while (localStorage.getItem(`user_${nickname}`)) {
                nickname = `${originalNickname}_${counter}`;
                counter++;
            }

            return nickname;
        }

        // –ò–º–∏—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è OAuth
        function createOAuthUser(provider, userData) {
            const nickname = generateUniqueNickname(provider, userData);

            const user = {
                id: Date.now(),
                nickname: nickname,
                email: userData.email || null,
                oauthProvider: provider,
                oauthId: userData.id || Date.now().toString(),
                avatar: getAvatarUrl(provider, userData),
                createdAt: new Date().toISOString(),
                friends: [],
                stats: {
                    gamesPlayed: 0,
                    wins: 0,
                    losses: 0,
                    draws: 0,
                    winRate: 0
                }
            };

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage (–≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ - –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
            localStorage.setItem('currentUser', JSON.stringify(user));
            localStorage.setItem('isLoggedIn', 'true');

            return user;
        }

        function getAvatarUrl(provider, data) {
            switch (provider) {
                case 'github':
                    return data.avatar_url;
                case 'discord':
                    return data.avatar
                        ? `https://cdn.discordapp.com/avatars/${data.id}/${data.avatar}.png`
                        : null;
                case 'google':
                    return data.picture;
                default:
                    return null;
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ OAuth callback
        async function handleCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const error = urlParams.get('error');

            const storedState = localStorage.getItem('oauth_state');
            const provider = localStorage.getItem('oauth_provider');

            const statusEl = document.getElementById('status');
            const messageEl = document.getElementById('message');
            const loadingEl = document.getElementById('loading');

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –¥–µ–º–æ-—Ä–µ–∂–∏–º (–µ—Å–ª–∏ –Ω–µ—Ç stored state, –∑–Ω–∞—á–∏—Ç –¥–µ–º–æ)
            const isDemoMode = !storedState;

            if (!isDemoMode) {
                // –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –¥–µ–º–æ-—Ä–µ–∂–∏–º
                localStorage.removeItem('oauth_state');
                localStorage.removeItem('oauth_provider');
            }

            if (error) {
                statusEl.textContent = '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏';
                statusEl.className = 'error';
                messageEl.textContent = `–û—à–∏–±–∫–∞: ${error}`;
                loadingEl.style.display = 'none';
                return;
            }

            try {
                let userData;

                if (isDemoMode) {
                    // –î–µ–º–æ-—Ä–µ–∂–∏–º: –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    userData = getDemoUserData(provider);
                    messageEl.textContent = `üéâ –î–µ–º–æ-${provider} –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!`;
                } else {
                    // –†–µ–∞–ª—å–Ω—ã–π OAuth: –ø—Ä–æ–≤–µ—Ä—è–µ–º state
                    if (state !== storedState) {
                        throw new Error('–ù–µ–≤–µ—Ä–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ OAuth');
                    }

                    if (!code) {
                        throw new Error('–ù–µ –ø–æ–ª—É—á–µ–Ω –∫–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
                    }

                    // –ò–º–∏—Ç–∏—Ä—É–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    userData = {
                        id: Date.now().toString(),
                        login: `${provider}_user_${Math.random().toString(36).substr(2, 6)}`,
                        email: `user@${provider}.com`,
                        name: `User from ${provider}`,
                        avatar_url: null,
                        picture: null
                    };
                    messageEl.textContent = `–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ ${provider} —É—Å–ø–µ—à–Ω–∞!`;
                }

                // –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const user = createOAuthUser(provider, userData);

                statusEl.textContent = '–£—Å–ø–µ—à–Ω–æ!';
                statusEl.className = 'success';
                messageEl.textContent += `\n–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${user.nickname}! –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...`;

                // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    window.location.href = '/dashboard.html';
                }, 2000);

            } catch (err) {
                console.error('OAuth callback error:', err);
                statusEl.textContent = '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏';
                statusEl.className = 'error';
                messageEl.textContent = err.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é';
                loadingEl.style.display = 'none';
            }
        }

        function getDemoUserData(provider) {
            const demoData = {
                github: {
                    id: '12345',
                    login: 'demo_github_user',
                    email: 'demo@github.com',
                    name: 'Demo GitHub User',
                    avatar_url: 'https://avatars.githubusercontent.com/u/1?v=4'
                },
                discord: {
                    id: '67890',
                    username: 'demo_discord_user',
                    email: 'demo@discord.com',
                    global_name: 'Demo Discord User',
                    avatar: null
                },
                google: {
                    id: '11111',
                    email: 'demo@gmail.com',
                    name: 'Demo Google User',
                    picture: 'https://lh3.googleusercontent.com/a/default-avatar'
                }
            };
            return demoData[provider] || demoData.github;
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', handleCallback);
    </script>
</body>
</html>